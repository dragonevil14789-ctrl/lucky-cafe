!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lucky Ice & Tea Caf√© ‚Äì ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°/‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°</title>
<style>
  :root{--rose:#ffeef3;--pink:#ff6fa3;--pink-2:#ff8fb8;--ink:#2b2b2b;--muted:#6b6b6b;--card:#ffffffee;--bd:#ffd6e5}
  *{box-sizing:border-box}body{margin:0;background:linear-gradient(#fff7fa, #fff) fixed;font-family: system-ui,-apple-system,Segoe UI,Roboto,Prompt,Arial,sans-serif;color:var(--ink)}
  header{position:sticky;top:0;background:rgba(255,255,255,.8);backdrop-filter: blur(10px);border-bottom:1px solid var(--bd);z-index:20}
  .wrap{max-width:1100px;margin:auto;padding:16px}
  .brand{display:flex;gap:10px;align-items:center}
  .brand .logo{font-size:28px}
  .brand h1{margin:0;font-size:22px;color:var(--pink)}
  .sub{color:#777;font-size:12px;margin-top:2px}
  .searchbar{display:flex;gap:8px;align-items:center}
  input[type="text"], textarea, input[type="tel"], input[type="number"],input[type="search"], input[type="email"], input[type="color"]{width:100%;padding:10px 12px;border:1px solid var(--bd);border-radius:12px;background:#fff7fb}
  input[type="color"]{padding:4px 6px;height:40px}
  button{cursor:pointer}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--bd);background:#fff}
  .btn.primary{background:var(--pink);border-color:var(--pink);color:#fff}
  .btn.primary:hover{filter:brightness(.96)}
  .btn.ghost{background:#fff}
  .grid{display:grid;grid-template-columns: repeat(auto-fill, minmax(240px,1fr));gap:14px}
  .card{border:1px solid var(--bd);background:var(--card);border-radius:18px;box-shadow:0 4px 10px -8px rgba(0,0,0,.2)}
  .card .pad{padding:14px}
  .item-title{display:flex;align-items:center;gap:8px}.thumb{width:72px;height:54px;display:flex;align-items:center;justify-content:center;background:#fff7fb;border:1px solid var(--bd);border-radius:12px;font-size:26px;overflow:hidden}.thumb img{width:100%;height:100%;object-fit:cover}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#fff0f6;border:1px solid var(--bd);color:#e2558e;font-size:12px}
  .price{color:#e34283;font-weight:700}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt24{margin-top:24px}
  .title-sec{font-weight:800;font-size:20px;display:flex;gap:8px;align-items:center;margin:8px 0}
  .dot{width:8px;height:8px;border-radius:50%;background:var(--pink)}
  footer{color:#888;text-align:center;padding:40px 10px}
  .hidden{display:none}
  /* Drawer / Modal */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;justify-content:flex-end;z-index:50;opacity:0;pointer-events:none;transition:.2s}
  .overlay.open{opacity:1;pointer-events:auto}
  .drawer{background:#fff;width:min(520px,100%);height:100%;border-left:1px solid var(--bd);border-top-left-radius:16px;border-bottom-left-radius:16px;transform:translateX(100%);transition:.25s}
  .overlay.open .drawer{transform:translateX(0)}
  .drawer .head{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);padding:12px 14px;border-top-left-radius:16px;display:flex;align-items:center;justify-content:space-between}
  .drawer .body{padding:14px;height:calc(100% - 54px);overflow:auto}
  .opt{padding:8px;border:1px solid var(--bd);border-radius:12px;background:#fff;display:flex;align-items:center;gap:8px}
  .opt.active{border-color:#ff8db8;background:#fff3f7}
  .qty{display:flex;align-items:center;gap:8px}
  .qty button{width:34px;height:34px;border-radius:10px;border:1px solid var(--bd);background:#fff}
  .list{display:flex;flex-direction:column;gap:10px}
  .mini{font-size:12px;color:#666}
  .right{margin-left:auto}
  /* Admin */
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border:1px solid #eee;padding:8px;text-align:left;font-size:14px}
  .pill{padding:2px 8px;border-radius:999px;background:#ffe8f2;color:#e2558e;border:1px solid var(--bd);font-size:12px}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#f4f4f4;border:1px solid #ddd;border-bottom-color:#c9c9c9;padding:1px 6px;border-radius:6px}
</style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <div class="brand"><div class="logo">üç®üßã</div><div><h1>Lucky Ice & Tea Caf√©</h1><div class="sub">‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡∏™‡∏±‡πà‡∏á‡∏á‡πà‡∏≤‡∏¢ ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‚ô°</div></div></div>
      <div class="searchbar" style="margin-left:auto;min-width:260px">
        <input id="search" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π..." />
        <button id="cartBtn" class="btn primary">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (<span id="cartCount">0</span>)</button>
        <button id="adminBtn" class="btn" title="‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô"><span class="kbd">Admin</span></button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Event Banner placeholder -->
    <div id="eventBanner"></div>

    <div class="title-sec"><span class="dot"></span> ‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
    <div id="grid" class="grid"></div>

    <div class="mt24 card">
      <div class="pad row">
        <div>
          <div class="item-title" style="gap:6px"><strong>‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢</strong> <span class="pill">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</span></div>
          <div class="mini">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö QR PromptPay / ‡πÇ‡∏≠‡∏ô / ‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn" id="showQR">‡πÅ‡∏™‡∏î‡∏á QR</button>
          <button class="btn primary" id="openCart2">‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ‚Ä¢ <span id="cartTotal1">0</span>‡∏ø</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Customize Drawer -->
  <div id="customize" class="overlay" aria-hidden="true">
    <div class="drawer">
      <div class="head"><strong id="czTitle">‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏°‡∏ô‡∏π</strong><button class="btn" onclick="closeCustomize()">‡∏õ‡∏¥‡∏î</button></div>
      <div class="body">
        <div id="czMeta" class="mini"></div>
        <div class="mt12">
          <div class="mini">‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏Å‡πâ‡∏ß</div>
          <div class="list" id="sizeList"></div>
        </div>
        <div class="mt12">
          <div class="mini">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô</div>
          <div class="list" id="sugarList"></div>
        </div>
        <div class="mt12">
          <div class="mini">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á</div>
          <div class="list" id="iceList"></div>
        </div>
        <div class="mt12">
          <div class="mini">‡∏ó‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á)</div>
          <div class="list" id="topList"></div>
        </div>
        <div class="mt12 qty">
          <span class="mini">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span>
          <button onclick="cz.qty=Math.max(1,cz.qty-1);renderCustomize()">-</button>
          <strong id="qtyBox">1</strong>
          <button onclick="cz.qty++;renderCustomize()">+</button>
        </div>
        <div class="mt12">
          <textarea id="note" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ñ‡∏∂‡∏á‡∏ö‡∏≤‡∏£‡∏¥‡∏™‡∏ï‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ó‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á / ‡πÅ‡∏¢‡∏Å‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á)"></textarea>
        </div>
        <div class="row mt16"><div class="mini">‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•</div><div id="lineTotal" style="color:#e34283;font-weight:800">0‡∏ø</div></div>
        <div class="row mt12"><button class="btn" onclick="closeCustomize()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="btn primary" onclick="addToCart()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button></div>
      </div>
    </div>
  </div>

  <!-- Cart Drawer -->
  <div id="cart" class="overlay" aria-hidden="true">
    <div class="drawer">
      <div class="head"><strong>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Ä¢ <span id="cartTotal">0</span>‡∏ø</strong><button class="btn" onclick="toggleCart(false)">‡∏õ‡∏¥‡∏î</button></div>
      <div class="body" id="cartBody"></div>
    </div>
  </div>

  <!-- Checkout Drawer -->
  <div id="out" class="overlay" aria-hidden="true">
    <div class="drawer">
      <div class="head"><strong>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô & ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</strong><button class="btn" onclick="toggleOut(false)">‡∏õ‡∏¥‡∏î</button></div>
      <div class="body">
        <div class="title-sec"><span class="dot"></span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á</div>
        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
          <input id="fName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" />
          <input id="fPhone" type="tel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" />
          <input id="fLine" type="text" placeholder="Line ID (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" />
        </div>
        <div class="title-sec mt16"><span class="dot"></span> ‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
          <label class="opt" id="optPickup"><input name="otype" type="radio" checked onchange="formState.type='pickup'"> ‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô</label>
          <label class="opt" id="optDelivery"><input name="otype" type="radio" onchange="formState.type='delivery'"> ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
        </div>
        <div id="addrBox" class="mt12 hidden"><textarea id="fAddr" rows="2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á"></textarea></div>

        <div class="title-sec mt16"><span class="dot"></span> ‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢ PromptPay</div>
        <div class="card"><div class="pad" style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
          <div>
            <div id="qrcode"></div>
            <div class="mini">‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
          </div>
          <div style="min-width:240px;flex:1">
            <div class="mini">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤)</div>
            <input id="payAmt" type="number" min="0" step="1" />
            <div class="mini mt8">PromptPay ID ‡∏£‡πâ‡∏≤‡∏ô</div>
            <input id="ppID" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678 ‡∏´‡∏£‡∏∑‡∏≠ 1234567890123" />
            <div class="row mt8"><button class="btn" onclick="regenQR()">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï QR</button><button class="btn" onclick="printBill()">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏¥‡∏•</button></div>
          </div>
        </div></div>

        <div class="title-sec mt16"><span class="dot"></span> ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>
        <div class="card"><div class="pad"><pre id="summary" style="white-space:pre-wrap;line-height:1.6"></pre></div></div>
        <div class="grid mt12" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr))">
          <button class="btn" onclick="copySummary()">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏õ LINE</button>
          <button class="btn" onclick="openLineShare()">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ä‡∏ï LINE</button>
          <button class="btn primary" onclick="confirmOrder()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="admin" class="overlay" aria-hidden="true">
    <div class="drawer">
      <div class="head"><strong>Admin ‚Äì ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</strong><button class="btn" onclick="toggleAdmin(false)">‡∏õ‡∏¥‡∏î</button></div>
      <div class="body">
        <!-- Event Manager -->
        <div class="card"><div class="pad">
          <div class="title-sec"><span class="dot"></span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô (Banner)</div>
          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));align-items:start">
            <label class="opt"><input id="evEnabled" type="checkbox"> ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
            <div></div>
          </div>
          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));align-items:start" id="eventMgr">
            <input id="evTitle" type="text" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©!" />
            <input id="evEmoji" type="text" placeholder="‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥/‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô ‡πÄ‡∏ä‡πà‡∏ô üéÄ" />
            <input id="evBg" type="color" value="#fff0f7" title="‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á" />
            <input id="evBorder" type="color" value="#ffcbe0" title="‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö" />
            <input id="evTitleColor" type="color" value="#e34283" title="‡∏™‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠" />
            <textarea id="evDetail" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°"></textarea>
            <div class="opt" style="flex-direction:column;align-items:flex-start">
              <div class="mini">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏ñ‡πâ‡∏≤‡πÉ‡∏™‡πà ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥)</div>
              <input id="evImg" type="file" accept="image/*" />
              <div class="mini">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:</div>
              <div id="evPreview" class="thumb" style="width:100px;height:70px">üéÄ</div>
              <div class="row mt8" style="gap:8px">
                <button class="btn" id="evClearImg">‡∏•‡∏ö‡∏£‡∏π‡∏õ</button>
                <button class="btn" id="evReset">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
                <button class="btn primary" id="evSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
              </div>
            </div>
          </div>
        </div></div>

        <div class="mt12">
          <div class="card"><div class="pad">
            <div class="title-sec"><span class="dot"></span> ‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
            <div class="grid" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr))" id="imgMgr"></div>
          </div></div>
        </div>
        <div class="mt12 row" style="gap:8px;align-items:center">
          <input id="qAdmin" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ö‡∏≠‡∏£‡πå/‡πÄ‡∏°‡∏ô‡∏π" oninput="renderAdmin()">
          <div class="row" style="gap:8px">
            <button class="btn" onclick="exportCSV()">Export CSV (Excel)</button>
            <button class="btn" onclick="exportSingleFile()">Export HTML (‡∏ù‡∏±‡∏á‡∏£‡∏π‡∏õ + ‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå)</button>
            <button class="btn" onclick="clearOrders()">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>
        </div>
        <div class="mt12">
          <table class="table" id="tbl"></table>
        </div>
      </div>
    </div>
  </div>

<script>
/*********************** CONFIG (‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) ***********************/
const CONFIG = {
  STORE_NAME: 'Lucky Ice & Tea Caf√©',
  DEFAULT_PROMPTPAY_ID: '',
  LINE_LIFF_ID: '',
  LINE_OA_URL: 'https://line.me/R/ti/p/~yourline',
  ORDER_WEBHOOK_URL: ''
};

/*********************** EVENT (Banner) ***********************/
const DEFAULT_EVENT = {
  enabled: true,
  title: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©!',
  detail: '‡πÄ‡∏°‡∏î‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà ‚Äì ‡∏û‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏´‡∏•‡πà‡∏≤‡πÄ‡∏°‡∏î‡∏™‡∏∏‡∏î‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô üíï',
  emoji: 'üéÄ',
  imgData: '', // base64 (optional). If set, use instead of emoji
  bg: '#fff0f7',
  border: '#ffcbe0',
  titleColor: '#e34283'
};
function getEvent(){ try{ return {...DEFAULT_EVENT, ...(JSON.parse(localStorage.getItem('eventData')||'{}')||{})}; }catch(e){ return {...DEFAULT_EVENT}; } }
function setEvent(ev){ localStorage.setItem('eventData', JSON.stringify(ev)); renderEventBanner(); }

function renderEventBanner(){
  const ev = getEvent();
  const holder = document.getElementById('eventBanner');
  holder.innerHTML = '';
  if(!ev.enabled) return;
  const card = document.createElement('div');
  card.className='card';
  card.style.background = ev.bg;
  card.style.borderColor = ev.border;
  card.style.marginBottom = '16px';
  const pad = document.createElement('div');
  pad.className='pad';
  pad.style.display='flex'; pad.style.alignItems='center'; pad.style.gap='12px';
  const icon = document.createElement('div');
  icon.style.fontSize = '26px';
  if(ev.imgData){
    const im=new Image(); im.src=ev.imgData; im.alt='event'; im.style.width='28px'; im.style.height='28px'; im.style.objectFit='cover'; im.style.borderRadius='6px';
    icon.appendChild(im);
  }else{
    icon.textContent = ev.emoji || 'üéâ';
  }
  const box = document.createElement('div');
  const t = document.createElement('div'); t.style.fontWeight='700'; t.style.color=ev.titleColor; t.textContent = ev.title||'';
  const d = document.createElement('div'); d.className='mini'; d.textContent = ev.detail||'';
  box.appendChild(t); box.appendChild(d);
  pad.appendChild(icon); pad.appendChild(box); card.appendChild(pad); holder.appendChild(card);
}

/*********************** DATA ***********************/
const TOPPINGS = [
  { id: 'boba', name: '‡πÑ‡∏Ç‡πà‡∏°‡∏∏‡∏Å (Boba)', price: 10 },
  { id: 'jelly', name: '‡∏ß‡∏∏‡πâ‡∏ô (Jelly)', price: 10 },
  { id: 'nata', name: '‡πÄ‡∏ô‡∏ï‡∏ï‡∏≤‡πÄ‡∏î‡∏≠‡πÇ‡∏Å‡πÇ‡∏Ñ‡πà', price: 10 },
  { id: 'cheese', name: '‡∏ä‡∏µ‡∏™‡πÇ‡∏ü‡∏°', price: 15 },
  { id: 'pudding', name: '‡∏û‡∏∏‡∏î‡∏î‡∏¥‡πâ‡∏á', price: 12 },
];
const SUGAR = [
  { id: '100', label: '‡∏´‡∏ß‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥' },
  { id: '70',  label: '‡∏´‡∏ß‡∏≤‡∏ô 70%' },
  { id: '50',  label: '‡∏´‡∏ß‡∏≤‡∏ô 50%' },
  { id: '30',  label: '‡∏´‡∏ß‡∏≤‡∏ô 30%' },
  { id: '0',   label: '‡πÑ‡∏°‡πà‡∏´‡∏ß‡∏≤‡∏ô' },
];
const ICE = [
  { id: 'normal', label: '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏õ‡∏Å‡∏ï‡∏¥' },
  { id: 'less',   label: '‡∏ô‡πâ‡∏≠‡∏¢' },
  { id: 'no',     label: '‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà' },
];
const SIZES = [
  { id: 'S', label: '‡πÅ‡∏Å‡πâ‡∏ß S (-5‡∏ø)', add: -5 },
  { id: 'M', label: '‡πÅ‡∏Å‡πâ‡∏ß M',        add: 0  },
  { id: 'L', label: '‡πÅ‡∏Å‡πâ‡∏ß L (+10‡∏ø)', add: 10 },
];
const MENU = [
  { id:'tea-milk',   name:'‡∏ä‡∏≤‡∏ô‡∏°‡πÑ‡∏ï‡πâ‡∏´‡∏ß‡∏±‡∏ô',   emoji:'üßã', base:35, cat:'‡∏ä‡∏≤‡∏ô‡∏°', desc:'‡∏ä‡∏≤‡∏´‡∏≠‡∏° ‡πÄ‡∏Ç‡πâ‡∏° ‡∏Å‡∏•‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏°' },
  { id:'tea-brown',  name:'‡∏ä‡∏≤‡∏ô‡∏°‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡πå‡∏ä‡∏π‡∏Å‡∏≤‡∏£‡πå', emoji:'üçØ', base:45, cat:'‡∏ä‡∏≤‡∏ô‡∏°', desc:'‡πÑ‡∏ã‡∏£‡∏±‡∏õ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ó‡∏£‡∏≤‡∏¢‡πÅ‡∏î‡∏á' },
  { id:'tea-matcha', name:'‡∏°‡∏±‡∏ó‡∏â‡∏∞‡∏•‡∏≤‡πÄ‡∏ï‡πâ',     emoji:'üçµ', base:40, cat:'‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', desc:'‡πÄ‡∏Ç‡πâ‡∏°‡∏•‡∏∞‡∏°‡∏∏‡∏ô' },
  { id:'coffee-latte', name:'‡∏•‡∏≤‡πÄ‡∏ï‡πâ‡πÄ‡∏¢‡πá‡∏ô',     emoji:'‚òï', base:45, cat:'‡∏Å‡∏≤‡πÅ‡∏ü', desc:'‡πÄ‡∏≠‡∏™‡πÄ‡∏û‡∏£‡∏™‡πÇ‡∏ã‡πà+‡∏ô‡∏°' },
  { id:'fruit-lychee', name:'‡∏•‡∏¥‡πâ‡∏ô‡∏à‡∏µ‡πà‡πÇ‡∏ã‡∏î‡∏≤',  emoji:'ü´ß', base:35, cat:'‡πÇ‡∏ã‡∏î‡∏≤', desc:'‡∏ã‡∏≤‡∏ö‡∏ã‡πà‡∏≤ ‡∏™‡∏î‡∏ä‡∏∑‡πà‡∏ô' },
  { id:'icecream-milk', name:'‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°‡∏ô‡∏°‡∏™‡∏î', emoji:'üç¶', base:25, cat:'‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°', desc:'‡∏ô‡∏∏‡πà‡∏° ‡∏´‡∏≠‡∏° ‡∏°‡∏±‡∏ô' },
];

const fmt = n => new Intl.NumberFormat('th-TH',{maximumFractionDigits:0}).format(n);

/*********************** STATE ***********************/
let query='';
let cart=[];
let cz=null;
let formState={name:'',phone:'',line:'',type:'pickup',addr:''};

/*********************** UI RENDER ***********************/
const el = sel => document.querySelector(sel);
const grid = el('#grid');
const search = el('#search');
search.addEventListener('input', ()=>{query=search.value.toLowerCase();renderGrid()});

function renderGrid(){
  const list = MENU.filter(m => (m.name+m.cat+m.desc).toLowerCase().includes(query));
  grid.innerHTML = '';
  if(!list.length){
    const msg = document.createElement('div');
    msg.className='mini'; msg.style.padding='16px'; msg.textContent='‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
    grid.appendChild(msg); return;
  }
  const imagesMap = JSON.parse(localStorage.getItem('menuImages')||'{}');
  list.forEach(m=>{
    const card = document.createElement('div'); card.className='card';
    const pad = document.createElement('div'); pad.className='pad'; card.appendChild(pad);

    const head = document.createElement('div'); head.className='item-title'; head.style.alignItems='flex-start'; pad.appendChild(head);

    const thumb = document.createElement('div'); thumb.className='thumb'; head.appendChild(thumb);
    const imgSrc = imagesMap[m.id] || m.img || null;
    if(imgSrc){ const im = document.createElement('img'); im.alt=m.name; im.src=imgSrc; thumb.appendChild(im); }
    else { thumb.textContent = m.emoji; }

    const meta = document.createElement('div'); head.appendChild(meta);
    const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent=m.name; meta.appendChild(title);
    const sub = document.createElement('div'); sub.className='mini'; sub.innerHTML = `${m.desc} ¬∑ <span class="tag">${m.cat}</span>`; meta.appendChild(sub);

    const row = document.createElement('div'); row.className='row mt12'; pad.appendChild(row);
    const price = document.createElement('div'); price.className='price'; price.textContent = fmt(m.base)+ '‡∏ø'; row.appendChild(price);
    const btn = document.createElement('button'); btn.type='button'; btn.className='btn primary'; btn.textContent='+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤';
    btn.onclick = ()=>startCustomize(m.id); row.appendChild(btn);

    grid.appendChild(card);
  });
}
renderGrid();

/*********************** CUSTOMIZE ***********************/
function startCustomize(id){
  const base = MENU.find(x=>x.id===id);
  cz = {base, size:'S', sugar:'100', ice:'normal', toppings:[], qty:1, note:''};
  renderCustomize();
  el('#customize').classList.add('open');
}
function closeCustomize(){el('#customize').classList.remove('open')}

function linePrice(sel){
  const sizeAdd = SIZES.find(s=>s.id===sel.size).add;
  const topAdd = sel.toppings.reduce((s,id)=> s + (TOPPINGS.find(t=>t.id===id)?.price||0), 0);
  return (sel.base.base + sizeAdd + topAdd) * sel.qty;
}

function renderCustomize(){
  el('#czTitle').textContent = cz.base.name;
  el('#czMeta').textContent = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ${fmt(cz.base.base)}‡∏ø`;
  el('#sizeList').innerHTML = SIZES.map(s=>`<label class="opt ${cz.size===s.id?'active':''}"><input type="radio" name="size" ${cz.size===s.id?'checked':''} onchange="cz.size='${s.id}';renderCustomize()"> ${s.label}</label>`).join('');
  el('#sugarList').innerHTML = SUGAR.map(s=>`<label class="opt ${cz.sugar===s.id?'active':''}"><input type="radio" name="sugar" ${cz.sugar===s.id?'checked':''} onchange="cz.sugar='${s.id}';renderCustomize()"> ${s.label}</label>`).join('');
  el('#iceList').innerHTML   = ICE.map(s=>`<label class="opt ${cz.ice===s.id?'active':''}"><input type="radio" name="ice" ${cz.ice===s.id?'checked':''} onchange="cz.ice='${s.id}';renderCustomize()"> ${s.label}</label>`).join('');
  el('#topList').innerHTML   = TOPPINGS.map(t=>`<label class="opt ${cz.toppings.includes(t.id)?'active':''}"><input type="checkbox" ${cz.toppings.includes(t.id)?'checked':''} onchange="toggleTop('${t.id}')"> ${t.name} <span class='right mini'>+${fmt(t.price)}‡∏ø</span></label>`).join('');
  el('#qtyBox').textContent = cz.qty;
  el('#note').value = cz.note;
  el('#note').oninput = (e)=>{cz.note=e.target.value};
  el('#lineTotal').textContent = fmt(linePrice(cz)) + '‡∏ø';
}
function toggleTop(id){
  const s=new Set(cz.toppings); if(s.has(id)) s.delete(id); else s.add(id); cz.toppings=[...s]; renderCustomize();
}
function addToCart(){
  const unit = cz.base.base + SIZES.find(s=>s.id===cz.size).add + cz.toppings.reduce((s,id)=>s+(TOPPINGS.find(t=>t.id===id)?.price||0),0);
  const line = { id: cz.base.id+'-'+Date.now(), name: cz.base.name, emoji: cz.base.emoji, size: cz.size, sugar: cz.sugar, ice: cz.ice, toppings:[...cz.toppings], qty: cz.qty, note: cz.note, unit, total: unit*cz.qty };
  cart.push(line); cz=null; closeCustomize(); toggleCart(true); renderCart();
}

/*********************** CART ***********************/
function cartSum(){return cart.reduce((s,x)=>s+x.total,0)}
function toggleCart(open){el('#cart').classList.toggle('open',!!open); if(open) renderCart()}
function renderCart(){
  el('#cartTotal').textContent = fmt(cartSum());
  el('#cartCount').textContent = cart.length;
  el('#cartTotal1').textContent = fmt(cartSum());
  const box = el('#cartBody');
  if(!cart.length){ box.innerHTML = `<div class='mini' style='text-align:center;padding:24px'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</div>`; return; }
  box.innerHTML = cart.map(it=>`
    <div class='card'><div class='pad'>
      <div class='row'><div class='item-title'><div style='font-size:30px'>${it.emoji}</div><div><strong>${it.name}</strong> <span class='mini'>(${it.size})</span><div class='mini'>‡∏´‡∏ß‡∏≤‡∏ô ${it.sugar}% ‚Ä¢ ‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á ${it.ice}${it.toppings.length?` ‚Ä¢ ‡∏ó‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á: ${it.toppings.map(id=>TOPPINGS.find(t=>t.id===id)?.name).join(', ')}`:''}${it.note?` ‚Ä¢ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${it.note}`:''}</div></div></div>
      <button class='btn' onclick="delLine('${it.id}')">‡∏•‡∏ö</button></div>
      <div class='row mt8'><div class='price'>${fmt(it.total)}‡∏ø</div>
        <div class='qty'><button onclick="chgQty('${it.id}',-1)">-</button><strong>${it.qty}</strong><button onclick="chgQty('${it.id}',+1)">+</button></div></div>
    </div></div>`).join('') + `
    <div class='row mt12'><div class='mini'>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div style='font-weight:800;color:#e34283'>${fmt(cartSum())}‡∏ø</div></div>
    <div class='row mt12'><button class='btn' onclick='toggleCart(false)'>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡πà‡∏≠</button><button class='btn primary' onclick='openCheckout()'>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button></div>`;
}
function delLine(id){cart = cart.filter(x=>x.id!==id); renderCart()}
function chgQty(id,d){cart = cart.map(x=> x.id===id?{...x, qty: Math.max(1,x.qty+d), total: Math.max(1,x.qty+d)*x.unit }:x); renderCart()}

/*********************** CHECKOUT ***********************/
function openCheckout(){
  if(!cart.length){alert('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á');return}
  toggleOut(true);
  el('#payAmt').value = cartSum();
  el('#ppID').value = CONFIG.DEFAULT_PROMPTPAY_ID || '';
  regenQR();
  renderSummary();
}
function toggleOut(open){ el('#out').classList.toggle('open',!!open) }

el('#optPickup').onclick = ()=>{formState.type='pickup'; el('#addrBox').classList.add('hidden'); renderSummary()}
el('#optDelivery').onclick = ()=>{formState.type='delivery'; el('#addrBox').classList.remove('hidden'); renderSummary()}

function renderSummary(){
  formState.name = el('#fName').value; formState.phone = el('#fPhone').value; formState.line = el('#fLine').value; formState.addr = el('#fAddr')?.value||'';
  const lines=[];
  lines.push(`‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ${CONFIG.STORE_NAME}`);
  lines.push(`‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${formState.name||'-'}  ‡πÇ‡∏ó‡∏£: ${formState.phone||'-'}`);
  lines.push(`‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${formState.type==='pickup'?'‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô':'‡∏à‡∏±‡∏î‡∏™‡πà‡∏á'}`);
  if(formState.type==='delivery') lines.push(`‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${formState.addr||'-'}`);
  lines.push('--------------------------------');
  cart.forEach((it,i)=>{
    lines.push(`${i+1}. ${it.name} (${it.size}) x${it.qty} = ${fmt(it.total)}‡∏ø`);
    lines.push(`   ‡∏´‡∏ß‡∏≤‡∏ô${it.sugar}% / ‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á${it.ice}${it.toppings.length?` / ‡∏ó‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á: ${it.toppings.map(id=>TOPPINGS.find(t=>t.id===id)?.name).join(', ')}`:''}`);
    if(it.note) lines.push(`   ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${it.note}`);
  });
  lines.push('--------------------------------');
  lines.push(`‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: ${fmt(cartSum())}‡∏ø`);
  if(formState.line) lines.push(`Line ID: ${formState.line}`);
  lines.push('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô‡∏Ñ‡πà‡∏∞ ‚ô°');
  el('#summary').textContent = lines.join('\n');
}

function copySummary(){
  renderSummary(); navigator.clipboard.writeText(el('#summary').textContent).then(()=>alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß'))
}
function printBill(){
  renderSummary();
  const txt = el('#summary').textContent;
  const w = window.open('', '_blank');
  if(!w){ alert('‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏¥‡∏•'); return; }
  w.document.open();
  w.document.write('<!doctype html><title>‡∏ö‡∏¥‡∏• - Lucky Caf√©</title><style>pre{font-family: ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;line-height:1.6;margin:24px}</style><pre id="p"></pre>');
  w.document.close();
  w.document.getElementById('p').textContent = txt;
  w.focus(); w.print();
}

async function openLineShare(){
  renderSummary();
  const text = encodeURIComponent(el('#summary').textContent);
  if(CONFIG.LINE_LIFF_ID){
    try{
      await ensureLIFF();
      if(window.liff.isLoggedIn()){
        await window.liff.sendMessages([{type:'text', text: el('#summary').textContent }]);
        alert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤ LINE OA ‡πÅ‡∏•‡πâ‡∏ß');
        return;
      }else{ window.liff.login(); return; }
    }catch(e){ console.warn('LIFF error', e); }
  }
  window.location.href = `https://line.me/R/msg/text/?${text}`;
}

function confirmOrder(){
  if(!el('#fName').value || !el('#fPhone').value){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå'); return }
  renderSummary();
  const record = { id: 'ORD'+Date.now(), when: new Date().toISOString(), customer:{...formState, name: el('#fName').value, phone: el('#fPhone').value, line: el('#fLine').value, addr: el('#fAddr')?.value||''}, items: cart, total: cartSum(), summary: el('#summary').textContent };
  const prev = JSON.parse(localStorage.getItem('orders')||'[]');
  prev.push(record); localStorage.setItem('orders', JSON.stringify(prev));
  if(CONFIG.ORDER_WEBHOOK_URL){
    try{ fetch(CONFIG.ORDER_WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(record) }); }catch(e){ console.warn('Webhook error', e); }
  }
  alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
  cart=[]; renderCart(); toggleOut(false); toggleCart(false);
}

/*********************** PROMPTPAY QR ***********************/
function genPromptPayPayload(id, amount){
  const T = (id||'').replace(/[^0-9]/g,'');
  const isPhone = T.length<=10;
  const tlv = (id, val) => id + ('00'+(val.length)).slice(-2) + val;
  const GUID = 'A000000677010111';
  const MAI = tlv('00', GUID) + (isPhone? tlv('01', ('0066'+T.replace(/^0/,''))): tlv('02', T));
  const merchant = tlv('29', MAI);
  const CURRENCY = tlv('53','764');
  const AMT = amount? tlv('54', String(+amount.toFixed? amount.toFixed(2): amount)): '';
  const COUNTRY = tlv('58','TH');
  const NAME = tlv('59',(CONFIG.STORE_NAME||'Cafe').substring(0,25));
  const CITY = tlv('60','Bangkok');
  const DATA = tlv('00','01') + tlv('01','11') + merchant + CURRENCY + AMT + COUNTRY + NAME + CITY + '6304';
  const crc = crc16(DATA);
  return DATA + crc;
}
function crc16(s){
  let crc = 0xFFFF; const poly = 0x1021;
  for(let i=0;i<s.length;i++){
    crc ^= s.charCodeAt(i)<<8;
    for(let j=0;j<8;j++) crc = (crc & 0x8000)? ((crc<<1)^poly) : (crc<<1), crc &= 0xFFFF;
  }
  return ('0000'+crc.toString(16)).slice(-4).toUpperCase();
}
function regenQR(){
  const id = (el('#ppID').value||'').trim();
  const amtRaw = parseFloat(el('#payAmt').value || '0');
  const amt = isFinite(amtRaw) && amtRaw>0 ? Math.round(amtRaw*100)/100 : undefined;
  const payload = genPromptPayPayload(id, amt);
  const box = el('#qrcode'); box.innerHTML='';
  const img = new Image(); img.alt='PromptPay QR'; img.width=240; img.height=240;
  img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=240x240&data='+encodeURIComponent(payload);
  box.appendChild(img);
}

/*********************** LIFF LOADER ***********************/
async function ensureLIFF(){
  if(!CONFIG.LINE_LIFF_ID) throw new Error('No LIFF ID');
  if(!window.liff){
    await new Promise((res,rej)=>{
      const s=document.createElement('script'); s.src='https://static.line-scdn.net/liff/edge/2/sdk.js'; s.onload=res; s.onerror=()=>rej(new Error('LIFF load failed')); document.head.appendChild(s);
    });
  }
  if(!window._liffInited){ await window.liff.init({ liffId: CONFIG.LINE_LIFF_ID }); window._liffInited=true; }
}

/*********************** ADMIN ***********************/
function toggleAdmin(open){ el('#admin').classList.toggle('open',!!open); if(open) renderAdmin() }
function renderAdmin(){
  // Event settings populate
  const ev = getEvent();
  const $ = id => document.getElementById(id);
  $('#evEnabled').checked = !!ev.enabled;
  $('#evTitle').value = ev.title||'';
  $('#evDetail').value = ev.detail||'';
  $('#evEmoji').value = ev.emoji||'';
  $('#evBg').value = ev.bg||'#fff0f7';
  $('#evBorder').value = ev.border||'#ffcbe0';
  $('#evTitleColor').value = ev.titleColor||'#e34283';
  const prev = $('#evPreview'); prev.innerHTML=''; if(ev.imgData){ const im=new Image(); im.src=ev.imgData; im.alt='preview'; im.style.width='100%'; im.style.height='100%'; im.style.objectFit='cover'; prev.appendChild(im);} else { prev.textContent = ev.emoji||'üéâ'; }

  // bind buttons (bind once)
  if(!renderAdmin._bound){
    $('#evImg').addEventListener('change', (e)=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{ const ev=getEvent(); ev.imgData=r.result; setEvent(ev); renderAdmin(); }; r.readAsDataURL(f);
    });
    $('#evClearImg').addEventListener('click', ()=>{ const ev=getEvent(); ev.imgData=''; setEvent(ev); renderAdmin(); });
    $('#evReset').addEventListener('click', ()=>{ setEvent({...DEFAULT_EVENT}); renderAdmin(); });
    $('#evSave').addEventListener('click', ()=>{
      const ev=getEvent();
      ev.enabled = $('#evEnabled').checked;
      ev.title = $('#evTitle').value.trim();
      ev.detail = $('#evDetail').value.trim();
      ev.emoji = $('#evEmoji').value.trim() || 'üéâ';
      ev.bg = $('#evBg').value;
      ev.border = $('#evBorder').value;
      ev.titleColor = $('#evTitleColor').value;
      setEvent(ev);
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß');
    });
    // Live preview
    ['evTitle','evDetail','evEmoji','evBg','evBorder','evTitleColor','evEnabled'].forEach(id=>{
      $(id).addEventListener('input', ()=>{
        const ev=getEvent();
        ev.enabled = $('#evEnabled').checked;
        ev.title = $('#evTitle').value;
        ev.detail = $('#evDetail').value;
        ev.emoji = $('#evEmoji').value;
        ev.bg = $('#evBg').value;
        ev.border = $('#evBorder').value;
        ev.titleColor = $('#evTitleColor').value;
        localStorage.setItem('eventData', JSON.stringify(ev));
        renderEventBanner();
      });
    });
    renderAdmin._bound = true;
  }

  // Image manager for menu images
  const holder = document.querySelector('#imgMgr');
  const map = JSON.parse(localStorage.getItem('menuImages')||'{}');
  holder.innerHTML = '';
  MENU.forEach(m=>{
    const box = document.createElement('div'); box.className='card'; const p=document.createElement('div'); p.className='pad'; box.appendChild(p);
    const row=document.createElement('div'); row.style.display='flex'; row.style.gap='10px'; row.style.alignItems='center'; p.appendChild(row);
    const preview=document.createElement('div'); preview.className='thumb'; preview.style.width='80px'; preview.style.height='60px';
    if(map[m.id]){ const im=new Image(); im.src=map[m.id]; im.alt=m.name; preview.appendChild(im);} else { preview.textContent=m.emoji; }
    const info=document.createElement('div'); info.innerHTML = `<div style='font-weight:700'>${m.name}</div><div class='mini'>${m.cat}</div>`;
    const ctr=document.createElement('div'); ctr.style.marginLeft='auto';
    const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*';
    inp.onchange = (e)=>{
      const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ map[m.id]=r.result; localStorage.setItem('menuImages', JSON.stringify(map)); renderGrid(); renderAdmin();}; r.readAsDataURL(f);
    };
    const del=document.createElement('button'); del.className='btn'; del.textContent='‡∏•‡∏ö‡∏£‡∏π‡∏õ'; del.onclick=()=>{ delete map[m.id]; localStorage.setItem('menuImages', JSON.stringify(map)); renderGrid(); renderAdmin(); };
    ctr.appendChild(inp); ctr.appendChild(del);
    row.appendChild(preview); row.appendChild(info); row.appendChild(ctr);
    holder.appendChild(box);
  });

  const rows = JSON.parse(localStorage.getItem('orders')||'[]');
  const q = (document.querySelector('#qAdmin').value||'').toLowerCase();
  const data = rows.filter(r=> JSON.stringify(r).toLowerCase().includes(q));
  const tbl = document.querySelector('#tbl');
  tbl.innerHTML = '<tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>ID</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏ß‡∏°(‡∏ø)</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th></tr>' +
    data.map(r=>`<tr>
      <td>${new Date(r.when).toLocaleString('th-TH')}</td>
      <td>${r.id}</td>
      <td>${r.customer.name} (${r.customer.phone})</td>
      <td style='text-align:right'>${fmt(r.total)}</td>
      <td>${r.items.map(i=>`${i.name}x${i.qty}`).join(', ')}</td>
    </tr>`).join('');
}
function exportCSV(){
  const rows = JSON.parse(localStorage.getItem('orders')||'[]');
  const headers = ['id','when','name','phone','type','addr','total','items'];
  const csv = [headers.join(',')].concat(rows.map(r=>[
    r.id,
    r.when,
    '"'+(r.customer.name||'')+'"',
    '"'+(r.customer.phone||'')+'"',
    r.customer.type,
    '"'+(r.customer.addr||'')+'"',
    r.total,
    '"'+r.items.map(i=>`${i.name}(${i.size})x${i.qty}`).join(' / ')+'"',
  ].join(','))).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='orders.csv'; a.click(); URL.revokeObjectURL(url);
}
function clearOrders(){ if(confirm('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) localStorage.removeItem('orders'), renderAdmin(); }

// Export single HTML with embedded Base64 images + eventData
function exportSingleFile(){
  try{
    const map = JSON.parse(localStorage.getItem('menuImages')||'{}');
    const ev  = getEvent();
    const seed = {menuImages: map, eventData: ev};
    const seedId = 'allSeed';
    const seedTag =
      '<script type="application/json" id="'+seedId+'">'+
        JSON.stringify(seed)+
      '</'+'script>';
    const loaderTag =
      '<script>' +
        '(function(){try{' +
          'var el=document.getElementById("'+seedId+'");' +
          'if(el&&el.textContent){var obj=JSON.parse(el.textContent)||{};' +
          'if(obj.menuImages) localStorage.setItem("menuImages", JSON.stringify(obj.menuImages));' +
          'if(obj.eventData) localStorage.setItem("eventData", JSON.stringify(obj.eventData));' +
          '}' +
        '}catch(e){console&&console.warn("seed fail",e);}})();' +
      '</'+'script>';
    let html = document.documentElement.outerHTML;
    const idx = html.lastIndexOf('</body>');
    if(idx > -1){ html = html.slice(0, idx) + seedTag + loaderTag + html.slice(idx); }
    const blob = new Blob([html], {type:'text/html;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='LuckyCafe_Menu.html'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }catch(e){ alert('Export ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+e.message); }
}

/*********************** WIRING ***********************/
function openQR(){ toggleOut(true); el('#payAmt').value = cartSum(); if(!el('#ppID').value) el('#ppID').value = CONFIG.DEFAULT_PROMPTPAY_ID||''; regenQR(); }
renderEventBanner();

el('#cartBtn').onclick=()=>toggleCart(true);
el('#openCart2').onclick=()=>toggleCart(true);
el('#showQR').onclick=()=>openQR();
el('#adminBtn').onclick=()=>{ const ok = prompt('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ):', '1234'); if(ok){ toggleAdmin(true); }};

/*********************** SELF TESTS (dev console) ***********************/
(function runSelfTests(){
  try{
    console.group('SelfTests');
    const before = grid.children.length; renderGrid(); const after = grid.children.length;
    console.assert(after>=1 && after===MENU.length, 'renderGrid count mismatch', {before, after, menu: MENU.length});
    startCustomize(MENU[0].id);
    console.assert(cz && document.querySelector('#customize').classList.contains('open'), 'customize drawer not opened');
    closeCustomize();
    const payload = genPromptPayPayload('0812345678', 123.45);
    console.assert(typeof payload==='string' && payload.includes('5303764') && payload.endsWith(crc16(payload.slice(0,-4))), 'PromptPay payload invalid');
    console.groupEnd();
  }catch(e){ console.error('SelfTests failed', e); }
})();

/*********************** START ***********************/
renderCart();

</script>
</body>
</html>


